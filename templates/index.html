{% extends "base.html" %}
{% block title %}QuickyPrint – Merge PDFs{% endblock %}

{% block content %}
<div class="container">
  <div class="card">

    <h1>Merge PDF Files</h1>
    <p class="subtitle">
      Merge <b>Multiple PDFs</b> instantly. No login required.
    </p>

    <!-- DROP ZONE -->
    <div class="drop-zone" id="dropZone">
      <div class="drop-inner">
        <div class="pdf-icon"></div>
        <h3>Select PDFs or Drag & Drop</h3>
        <span id="fileCount">No files selected</span>
      </div>

      <!-- IMPORTANT:
           file input WITHOUT click JS -->
      <input
        type="file"
        id="fileInput"
        multiple
        accept="application/pdf"
      >
    </div>

    <!-- FILE LIST -->
    <ul id="fileList"></ul>

    <!-- MERGE BUTTON -->
    <button class="btn" id="mergeBtn">
      <span id="btnText">Merge & Download</span>
      <span class="spinner" id="spinner"></span>
    </button>

  
    <!-- FEATURES -->
    <div class="features">
      <div class="feature">
        <img src="{{ url_for('static', filename='images/temp.png') }}">
        <span>No Login</span>
      </div>
      <div class="feature">
        <img src="{{ url_for('static', filename='images/autodelete.png') }}">
        <span>Auto Delete</span>
      </div>
      <div class="feature">
        <img src="{{ url_for('static', filename='images/private.png') }}">
        <span>100% Private</span>
      </div>
    </div>

  </div>
</div>

<!-- ================= JS ================= -->
 
<script>
  const MAX_FILES = 20;
const MAX_TOTAL_SIZE = 25 * 1024 * 1024; // 25 MB

const dropZone = document.getElementById("dropZone");
const fileInput = document.getElementById("fileInput");
const fileList = document.getElementById("fileList");
const fileCount = document.getElementById("fileCount");
const mergeBtn = document.getElementById("mergeBtn");

let files = [];

/* ❌ IMPORTANT FIX:
   remove manual click trigger
   browser will handle it naturally */

/* FILE SELECT */
fileInput.addEventListener("change", () => {
  const selected = Array.from(fileInput.files);

  if (selected.length > MAX_FILES) {
    alert("You can upload maximum 20 PDF files only");
    fileInput.value = "";
    return;
  }

  const totalSize = selected.reduce((sum, f) => sum + f.size, 0);
  if (totalSize > MAX_TOTAL_SIZE) {
    alert("Total file size must be under 25 MB");
    fileInput.value = "";
    return;
  }

  files = selected;
  renderList();
});


/* DRAG OVER */
dropZone.addEventListener("dragover", (e) => {
  e.preventDefault();
  dropZone.classList.add("drag-active");
});

/* DRAG LEAVE */
dropZone.addEventListener("dragleave", () => {
  dropZone.classList.remove("drag-active");
});

/* DROP */
dropZone.addEventListener("drop", (e) => {
  e.preventDefault();
  dropZone.classList.remove("drag-active");

  const dropped = Array.from(e.dataTransfer.files)
    .filter(f => f.type === "application/pdf");

  files = files.concat(dropped);
  renderList();
});

/* RENDER FILE LIST */
function renderList() {
  fileList.innerHTML = "";
  fileCount.innerText = files.length
    ? files.length + " PDF(s) selected"
    : "No files selected";

  files.forEach((file, i) => {
    const li = document.createElement("li");
    li.innerHTML = `
      <span>${file.name}</span>
      <button onclick="removeFile(${i})">✖</button>
    `;
    fileList.appendChild(li);
  });
}

/* REMOVE FILE */
function removeFile(i) {
  files.splice(i, 1);
  renderList();
}

/* MERGE & DOWNLOAD */
mergeBtn.addEventListener("click", async () => {
  if (files.length === 0) {
    showError("Please select at least one PDF file");
    return;
  }

  const formData = new FormData();
  files.forEach(f => formData.append("pdfs", f));

  const res = await fetch("/merge", {
    method: "POST",
    body: formData
  });

  if (!res.ok) {
    alert("Merge failed");
    return;
  }

  const blob = await res.blob();
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "merged-by-quickyprint.pdf";
  a.click();

  URL.revokeObjectURL(url);
});
</script>
{% endblock %}
